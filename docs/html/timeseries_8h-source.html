<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>timeseries.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>timeseries.h</h1><div class="fragment"><pre>00001 <span class="comment">//-&lt; TIMESERIES.H &gt;--------------------------------------------------*--------*</span>
00002 <span class="comment">// FastDB                    Version 1.0         (c) 1999  GARRET    *     ?  *</span>
00003 <span class="comment">// (Post Relational Database Management System)                      *   /\|  *</span>
00004 <span class="comment">//                                                                   *  /  \  *</span>
00005 <span class="comment">//                          Created:     22-Nov-2002  K.A. Knizhnik  * / [] \ *</span>
00006 <span class="comment">//                          Last update: 22-Nov-2002  K.A. Knizhnik  * GARRET *</span>
00007 <span class="comment">//-------------------------------------------------------------------*--------*</span>
00008 <span class="comment">// Container for time serires data</span>
00009 <span class="comment">//-------------------------------------------------------------------*--------*</span>
00010 
00011 <span class="preprocessor">#ifndef __TIMESERIES_H__</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#define __TIMESERIES_H__</span>
00013 <span class="preprocessor"></span>
00014 <span class="preprocessor">#include "fastdb.h"</span>
00015 
00016 BEGIN_FASTDB_NAMESPACE
00017 
00018 <span class="preprocessor">#define INFINITE_TIME 0x7fffffff</span>
00019 <span class="preprocessor"></span>
00069 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00070"></a><a class="code" href="classdbTimeSeriesBlock.html">00070</a> <span class="keyword">class </span><a class="code" href="classdbTimeSeriesBlock.html">dbTimeSeriesBlock</a> { 
00071   <span class="keyword">public</span>:
00072     db_int4 used;
00073     db_int8 blockId;
00074     <a class="code" href="classdbArray.html">dbArray&lt;T&gt;</a> elements;
00075   
00076     TYPE_DESCRIPTOR((KEY(blockId, INDEXED), FIELD(used), FIELD(elements)));
00077 };
00078 
00079 
00085 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00086"></a><a class="code" href="classdbTimeSeriesProcessor.html">00086</a> <span class="keyword">class </span><a class="code" href="classdbTimeSeriesProcessor.html">dbTimeSeriesProcessor</a> { 
00087     <span class="keyword">struct </span>Interval { 
00088         db_int8 from;
00089         db_int8 till;
00090     };
00091 
00092   <span class="keyword">public</span>:
<a name="l00097"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora0">00097</a>     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora0">process</a>(T <span class="keyword">const</span>&amp;) {}
00098     
<a name="l00104"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora1">00104</a>     <span class="keywordtype">void</span> <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora1">add</a>(oid_t oid, T <span class="keyword">const</span>&amp; data) 
00105     { 
00106         Interval interval;
00107         interval.from = generateBlockId(oid, data.time() - maxBlockTimeInterval);
00108         interval.till = generateBlockId(oid, data.time());
00109         <a class="code" href="classdbCursor.html">dbCursor&lt; dbTimeSeriesBlock&lt;T&gt;</a> &gt; blocks;
00110         blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a20">select</a>(selectBlock, dbCursorForUpdate, &amp;interval);
00111         <span class="keywordflow">if</span> (blocks.<a class="code" href="classdbCursor.html#dbCursora6">last</a>()) { 
00112             insertInBlock(oid, blocks, data);
00113         } <span class="keywordflow">else</span> { 
00114             addNewBlock(oid, data);
00115         }
00116     }
00117 
<a name="l00124"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora2">00124</a>     <span class="keywordtype">void</span> <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora2">select</a>(oid_t oid, time_t from, time_t till) 
00125     { 
00126         Interval interval;
00127         interval.from = generateBlockId(oid, from - maxBlockTimeInterval);
00128         interval.till = generateBlockId(oid, till);
00129         <a class="code" href="classdbCursor.html">dbCursor&lt; dbTimeSeriesBlock&lt;T&gt;</a> &gt; blocks;
00130         <span class="keywordflow">if</span> (blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a20">select</a>(selectBlock, dbCursorViewOnly, &amp;interval)) { 
00131             <span class="keywordflow">do</span> { 
00132                 <span class="keywordtype">int</span> n = blocks-&gt;used;
00133                 T <span class="keyword">const</span>* e =  blocks-&gt;elements.<a class="code" href="classdbCursor.html#dbCursora2">get</a>();
00134                 <span class="keywordtype">int</span> l = 0, r = n;
00135                 <span class="keywordflow">while</span> (l &lt; r)  {
00136                     <span class="keywordtype">int</span> i = (l+r) &gt;&gt; 1;
00137                     <span class="keywordflow">if</span> (from &gt; e[i].time()) { 
00138                         l = i+1;
00139                     } <span class="keywordflow">else</span> { 
00140                         r = i;
00141                     }
00142                 }
00143                 assert(l == r &amp;&amp; (l == n || e[l].time() &gt;= from)); 
00144                 <span class="keywordflow">while</span> (l &lt; n &amp;&amp; e[l].time() &lt;= till) {
00145                     <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora0">process</a>(e[l++]);
00146                 }
00147             } <span class="keywordflow">while</span> (blocks.<a class="code" href="classdbCursor.html#dbCursora3">next</a>());
00148         }
00149     }
00150     
<a name="l00156"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora3">00156</a>     time_t <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora3">getFirstTime</a>(oid_t oid) 
00157     {
00158         Interval interval;
00159         interval.from = generateBlockId(oid, 0);
00160         interval.till = generateBlockId(oid, INFINITE_TIME);
00161         <a class="code" href="classdbCursor.html">dbCursor&lt; dbTimeSeriesBlock&lt;T&gt;</a> &gt; blocks;
00162         blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a31">setSelectionLimit</a>(1);
00163         <span class="keywordflow">if</span> (blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a20">select</a>(selectBlock, dbCursorViewOnly, &amp;interval)) { 
00164             <span class="keywordflow">return</span> blocks-&gt;elements[0].time();
00165         }
00166         <span class="keywordflow">return</span> (time_t)-1;
00167     }
00168     
<a name="l00174"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora4">00174</a>     time_t <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora4">getLastTime</a>(oid_t oid) 
00175     {
00176         Interval interval;
00177         interval.from = generateBlockId(oid, 0);
00178         interval.till = generateBlockId(oid, INFINITE_TIME);
00179         <a class="code" href="classdbCursor.html">dbCursor&lt; dbTimeSeriesBlock&lt;T&gt;</a> &gt; blocks;
00180         blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a31">setSelectionLimit</a>(1);
00181         <span class="keywordflow">if</span> (blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a20">select</a>(selectBlockReverse, dbCursorViewOnly, &amp;interval)) { 
00182             <span class="keywordflow">return</span> blocks-&gt;elements[blocks-&gt;used-1].time();
00183         }
00184         <span class="keywordflow">return</span> (time_t)-1;
00185     }
00186     
<a name="l00192"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora5">00192</a>     size_t <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora5">getNumberOfElements</a>(oid_t oid) 
00193     {
00194         Interval interval;
00195         interval.from = generateBlockId(oid, 0);
00196         interval.till = generateBlockId(oid, INFINITE_TIME);
00197         <a class="code" href="classdbCursor.html">dbCursor&lt; dbTimeSeriesBlock&lt;T&gt;</a> &gt; blocks;
00198         <span class="keywordtype">int</span> n = 0;
00199         <span class="keywordflow">if</span> (blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a20">select</a>(selectBlock, dbCursorViewOnly, &amp;interval)) {
00200             <span class="keywordflow">do</span> { 
00201                 n += blocks-&gt;used;
00202             } <span class="keywordflow">while</span> (blocks.<a class="code" href="classdbCursor.html#dbCursora3">next</a>());
00203         }
00204         <span class="keywordflow">return</span> n;
00205     }
00206         
<a name="l00216"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora6">00216</a>     size_t <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora6">getInterval</a>(oid_t oid, time_t from, time_t till, T* buf, size_t bufSize) 
00217     { 
00218         Interval interval;
00219         interval.from = generateBlockId(oid, from == 0 ? 0 : from - maxBlockTimeInterval);
00220         interval.till = generateBlockId(oid, till);
00221         <a class="code" href="classdbCursor.html">dbCursor&lt; dbTimeSeriesBlock&lt;T&gt;</a> &gt; blocks;
00222         size_t nSelected = 0;
00223         <span class="keywordflow">if</span> (blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a20">select</a>(selectBlock, dbCursorViewOnly, &amp;interval)) { 
00224             <span class="keywordflow">do</span> { 
00225                 <span class="keywordtype">int</span> n = blocks-&gt;used;
00226                 T <span class="keyword">const</span>* e =  blocks-&gt;elements.<a class="code" href="classdbCursor.html#dbCursora2">get</a>();
00227                 <span class="keywordtype">int</span> l = 0, r = n;
00228                 <span class="keywordflow">while</span> (l &lt; r)  {
00229                     <span class="keywordtype">int</span> i = (l+r) &gt;&gt; 1;
00230                     <span class="keywordflow">if</span> (from &gt; e[i].time()) { 
00231                         l = i+1;
00232                     } <span class="keywordflow">else</span> { 
00233                         r = i;
00234                     }
00235                 }
00236                 assert(l == r &amp;&amp; (l == n || e[l].time() &gt;= from)); 
00237                 <span class="keywordflow">while</span> (l &lt; n &amp;&amp; e[l].time() &lt;= till) {
00238                     <span class="keywordflow">if</span> (nSelected &lt; bufSize) { 
00239                         buf[nSelected] = e[l];
00240                     }
00241                     l += 1;
00242                     nSelected += 1;
00243                 }
00244             } <span class="keywordflow">while</span> (blocks.<a class="code" href="classdbCursor.html#dbCursora3">next</a>());
00245         }
00246         <span class="keywordflow">return</span> nSelected;
00247     }        
00248         
<a name="l00256"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora7">00256</a>     <span class="keywordtype">bool</span> <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora7">getElement</a>(oid_t oid, T&amp; elem, time_t t) 
00257     { 
00258         <span class="keywordflow">return</span> <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora6">getInterval</a>(oid, t, t, &amp;elem, 1) == 1;
00259     }        
00260         
<a name="l00270"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora8">00270</a>     size_t <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora8">getFirstInterval</a>(oid_t oid, time_t till, T* buf, size_t bufSize) 
00271     {
00272         <span class="keywordflow">if</span> (bufSize == 0) { 
00273             <span class="keywordflow">return</span> 0;
00274         }
00275         Interval interval;
00276         interval.from = generateBlockId(oid, 0);
00277         interval.till = generateBlockId(oid, till);
00278         <a class="code" href="classdbCursor.html">dbCursor&lt; dbTimeSeriesBlock&lt;T&gt;</a> &gt; blocks;
00279         size_t nSelected = 0;
00280         <span class="keywordflow">if</span> (blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a20">select</a>(selectBlock, dbCursorViewOnly, &amp;interval)) { 
00281             <span class="keywordflow">do</span> { 
00282                 <span class="keywordtype">int</span> n = blocks-&gt;used;
00283                 T <span class="keyword">const</span>* e =  blocks-&gt;elements.<a class="code" href="classdbCursor.html#dbCursora2">get</a>();
00284                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n &amp;&amp; e[i].time() &lt;= till; i++) { 
00285                     buf[nSelected++] = e[i];
00286                     <span class="keywordflow">if</span> (nSelected == bufSize) { 
00287                         <span class="keywordflow">return</span> nSelected;
00288                     }
00289                 }
00290             } <span class="keywordflow">while</span> (blocks.<a class="code" href="classdbCursor.html#dbCursora3">next</a>());
00291         }
00292         <span class="keywordflow">return</span> nSelected;
00293     }        
00294 
00295 
<a name="l00305"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora9">00305</a>     size_t <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora9">getLastInterval</a>(oid_t oid, time_t from, T* buf, size_t bufSize) 
00306     {
00307         <span class="keywordflow">if</span> (bufSize == 0) { 
00308             <span class="keywordflow">return</span> 0;
00309         }
00310         Interval interval;
00311         interval.from = generateBlockId(oid, from == 0 ? 0 : from - maxBlockTimeInterval);
00312         interval.till = generateBlockId(oid, INFINITE_TIME);
00313         <a class="code" href="classdbCursor.html">dbCursor&lt; dbTimeSeriesBlock&lt;T&gt;</a> &gt; blocks;
00314 
00315         size_t nSelected = 0;
00316         blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a20">select</a>(selectBlock, dbCursorViewOnly, &amp;interval);
00317         <span class="keywordflow">if</span> (blocks.<a class="code" href="classdbCursor.html#dbCursora6">last</a>()) { 
00318             <span class="keywordflow">do</span> { 
00319                 <span class="keywordtype">int</span> n = blocks-&gt;used;
00320                 T <span class="keyword">const</span>* e =  blocks-&gt;elements.<a class="code" href="classdbCursor.html#dbCursora2">get</a>();
00321                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = n; --i &gt;= 0 &amp;&amp; e[i].time() &gt;= from;) { 
00322                     buf[nSelected++] = e[i];
00323                     <span class="keywordflow">if</span> (nSelected == bufSize) { 
00324                         <span class="keywordflow">return</span> nSelected;
00325                     }
00326                 }
00327             } <span class="keywordflow">while</span> (blocks.<a class="code" href="classdbCursor.html#dbCursora4">prev</a>());
00328         }
00329         <span class="keywordflow">return</span> nSelected;
00330     }        
00331 
00332 
00333 
<a name="l00340"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora10">00340</a>     <span class="keywordtype">bool</span> <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora10">hasElement</a>(oid_t oid, time_t t) 
00341     { 
00342         T dummy;
00343         <span class="keywordflow">return</span> <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora7">getElement</a>(oid, dummy, t);
00344     }        
00345 
<a name="l00357"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora11">00357</a>     <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora11">dbTimeSeriesProcessor</a>(<a class="code" href="classdbDatabase.html">dbDatabase</a>&amp; database, <span class="keywordtype">int</span> minElementsInBlock=100, <span class="keywordtype">int</span> maxElementsInBlock=100, time_t maxBlockTimeInterval=0) :
00358         db(database) 
00359     {
00360         assert(minElementsInBlock &gt; 0 &amp;&amp; maxElementsInBlock &gt;= minElementsInBlock);
00361         <span class="keywordflow">if</span> (maxBlockTimeInterval == 0) { 
00362             maxBlockTimeInterval = 2*(maxElementsInBlock*24*60*60); <span class="comment">// doubled interval in seconds, one element per day</span>
00363         }        
00364         this-&gt;maxElementsInBlock = maxElementsInBlock;
00365         this-&gt;minElementsInBlock = minElementsInBlock;
00366         this-&gt;maxBlockTimeInterval = maxBlockTimeInterval;
00367 
00368         <span class="comment">// correct instance of interval will be specified in select</span>
00369         Interval* dummy = NULL;
00370         selectBlock = <span class="stringliteral">"blockId between"</span>,dummy-&gt;from,<span class="stringliteral">"and"</span>,dummy-&gt;till;
00371         selectBlockReverse = <span class="stringliteral">"blockId between"</span>,dummy-&gt;from,<span class="stringliteral">"and"</span>,dummy-&gt;till,<span class="stringliteral">"order by blockId desc"</span>;
00372     }
00373 
<a name="l00381"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora12">00381</a>     <span class="keywordtype">int</span> <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora12">remove</a>(oid_t oid, time_t from, time_t till)
00382     {
00383         Interval interval;
00384         interval.from = generateBlockId(oid, from == 0 ? 0 : from - maxBlockTimeInterval);
00385         interval.till = generateBlockId(oid, till);
00386         <a class="code" href="classdbCursor.html">dbCursor&lt; dbTimeSeriesBlock&lt;T&gt;</a> &gt; blocks;
00387         size_t nRemoved = 0;
00388         <span class="keywordflow">if</span> (blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a20">select</a>(selectBlock, dbCursorForUpdate, &amp;interval)) { 
00389             <span class="keywordflow">do</span> { 
00390                 <span class="keywordtype">int</span> n = blocks-&gt;used;
00391                 T <span class="keyword">const</span>* e =  blocks-&gt;elements.<a class="code" href="classdbCursor.html#dbCursora2">get</a>();
00392                 <span class="keywordtype">int</span> l = 0, r = n;
00393                 <span class="keywordflow">while</span> (l &lt; r)  {
00394                     <span class="keywordtype">int</span> i = (l+r) &gt;&gt; 1;
00395                     <span class="keywordflow">if</span> (from &gt; e[i].time()) { 
00396                         l = i+1;
00397                     } <span class="keywordflow">else</span> { 
00398                         r = i;
00399                     }
00400                 }
00401                 assert(l == r &amp;&amp; (l == n || e[l].time() &gt;= from)); 
00402                 <span class="keywordflow">while</span> (r &lt; n &amp;&amp; e[r].time() &lt;= till) {
00403                     r += 1;
00404                     nRemoved += 1;
00405                 }
00406                 <span class="keywordflow">if</span> (l == 0 &amp;&amp; r == n) { 
00407                     blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a14">remove</a>();
00408                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l &lt; n &amp;&amp; l != r) { 
00409                     <span class="keywordflow">if</span> (l == 0) { 
00410                         blocks-&gt;blockId = generateBlockId(oid, e[r].time());
00411                     }
00412                     T* ue = blocks-&gt;elements.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a28">update</a>();
00413                     <span class="keywordflow">while</span> (r &lt; n) { 
00414                         ue[l++] = ue[r++];
00415                     }
00416                     blocks-&gt;used = l;
00417                     blocks.<a class="code" href="classdbAnyCursor.html#dbCursor_3_01dbTimeSeriesBlock_3_01T_01_4_01_4a28">update</a>();
00418                 }
00419             } <span class="keywordflow">while</span> (blocks.nextAvailable());
00420         }
00421         <span class="keywordflow">return</span> nRemoved;
00422     }        
00423     
00424     <span class="keyword">virtual</span>~<a class="code" href="classdbTimeSeriesProcessor.html">dbTimeSeriesProcessor</a>() {}
00425 
<a name="l00431"></a><a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora14">00431</a>     <span class="keywordtype">int</span> <a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora14">_openIteratorCursor</a>(<a class="code" href="classdbCursor.html">dbCursor</a>&lt; <a class="code" href="classdbTimeSeriesBlock.html">dbTimeSeriesBlock&lt;T&gt;</a> &gt;&amp; cursor, oid_t oid, time_t from, time_t till) 
00432     { 
00433         Interval interval;
00434         interval.from = generateBlockId(oid, from == 0 ? 0 : from - maxBlockTimeInterval);
00435         interval.till = generateBlockId(oid, till);
00436         <span class="keywordflow">return</span> cursor.select(selectBlock, dbCursorViewOnly, &amp;interval);
00437     }
00438 
00439    <span class="keyword">private</span>:
00440      db_int8 generateBlockId(oid_t oid, time_t date) 
00441      {
00442         <span class="keywordflow">return</span> cons_int8(oid, date);
00443      }
00444      
00445      
00446      <span class="keywordtype">void</span> addNewBlock(oid_t oid, T <span class="keyword">const</span>&amp; data)
00447      {
00448          <a class="code" href="classdbTimeSeriesBlock.html">dbTimeSeriesBlock&lt;T&gt;</a> block;
00449          block.<a class="code" href="classdbTimeSeriesBlock.html#dbTimeSeriesBlockm1">blockId</a> = generateBlockId(oid, data.time());
00450          block.<a class="code" href="classdbTimeSeriesBlock.html#dbTimeSeriesBlockm2">elements</a>.resize(minElementsInBlock);
00451          block.<a class="code" href="classdbTimeSeriesBlock.html#dbTimeSeriesBlockm0">used</a> = 1;
00452          block.<a class="code" href="classdbTimeSeriesBlock.html#dbTimeSeriesBlockm2">elements</a>.putat(0, data);
00453          insert(block);
00454      }
00455 
00456      <span class="keywordtype">void</span> insertInBlock(oid_t oid, <a class="code" href="classdbCursor.html">dbCursor</a>&lt; <a class="code" href="classdbTimeSeriesBlock.html">dbTimeSeriesBlock&lt;T&gt;</a> &gt;&amp; blocks, T <span class="keyword">const</span>&amp; data)
00457      {
00458          time_t t = data.time();
00459          <span class="keywordtype">int</span> i, n = blocks-&gt;used;
00460 
00461          T <span class="keyword">const</span>* e =  blocks-&gt;elements.get();
00462          <span class="keywordtype">int</span> l = 0, r = n;
00463          <span class="keywordflow">while</span> (l &lt; r)  {
00464              i = (l+r) &gt;&gt; 1;
00465              <span class="keywordflow">if</span> (t &gt; e[i].time()) { 
00466                  l = i+1;
00467              } <span class="keywordflow">else</span> { 
00468                  r = i;
00469              }
00470          }
00471          assert(l == r &amp;&amp; (l == n || e[l].time() &gt;= t));
00472          <span class="keywordflow">if</span> (r == 0) { 
00473              <span class="keywordflow">if</span> (e[n-1].time() - t &gt; maxBlockTimeInterval || n == maxElementsInBlock) { 
00474                  addNewBlock(oid, data);
00475                  <span class="keywordflow">return</span>;
00476              }
00477              blocks-&gt;blockId = generateBlockId(oid, t);
00478          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r == n) {
00479              <span class="keywordflow">if</span> (t - e[0].time() &gt; maxBlockTimeInterval || n == maxElementsInBlock) { 
00480                  addNewBlock(oid, data);
00481                  <span class="keywordflow">return</span>;
00482              } 
00483          }
00484          <span class="keywordflow">if</span> ((size_t)n == blocks-&gt;elements.length()) { 
00485              <span class="keywordflow">if</span> (n == maxElementsInBlock) { 
00486                  T* u = blocks-&gt;elements.update();
00487                  addNewBlock(oid, u[n-1]);
00488                  <span class="keywordflow">for</span> (i = n; --i &gt; r; ) { 
00489                      u[i] = u[i-1];
00490                  }
00491                  u[r] = data;
00492                  blocks.update();
00493                  <span class="keywordflow">return</span>;
00494              }
00495              blocks-&gt;elements.resize(n + minElementsInBlock &lt; maxElementsInBlock ? n + minElementsInBlock : maxElementsInBlock);
00496          }
00497          T* u = blocks-&gt;elements.update();
00498          <span class="keywordflow">for</span> (i = n; i &gt; r; i--) { 
00499              u[i] = u[i-1];
00500          }
00501          u[r] = data;
00502          blocks-&gt;used += 1;
00503          blocks.update();
00504      }
00505 
00506      <a class="code" href="classdbDatabase.html">dbDatabase</a>&amp; db;
00507      <span class="keywordtype">int</span>         maxElementsInBlock;
00508      <span class="keywordtype">int</span>         minElementsInBlock;
00509      time_t      maxBlockTimeInterval;     
00510      <a class="code" href="classdbQuery.html">dbQuery</a>     selectBlock;
00511      <a class="code" href="classdbQuery.html">dbQuery</a>     selectBlockReverse; 
00512 };
00513     
00514 
00518 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00519"></a><a class="code" href="classdbTimeSeriesIterator.html">00519</a> <span class="keyword">class </span><a class="code" href="classdbTimeSeriesIterator.html">dbTimeSeriesIterator</a> { 
00520   <span class="keyword">public</span>:
<a name="l00528"></a><a class="code" href="classdbTimeSeriesIterator.html#dbTimeSeriesIteratora0">00528</a>     <span class="keywordtype">void</span> <a class="code" href="classdbTimeSeriesIterator.html#dbTimeSeriesIteratora0">start</a>(<a class="code" href="classdbTimeSeriesProcessor.html">dbTimeSeriesProcessor&lt;T&gt;</a>* processor, oid_t oid, time_t from, time_t till) { 
00529         first = pos = -1;
00530         this-&gt;till = till;
00531         <span class="keywordflow">if</span> (processor-&gt;<a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora14">_openIteratorCursor</a>(blocks, oid, from, till)) { 
00532             <span class="keywordflow">do</span> { 
00533                 <span class="keywordtype">int</span> n = blocks-&gt;used;
00534                 T <span class="keyword">const</span>* e =  blocks-&gt;elements.<a class="code" href="classdbCursor.html#dbCursora2">get</a>();
00535                 <span class="keywordtype">int</span> l = 0, r = n;
00536                 <span class="keywordflow">while</span> (l &lt; r)  {
00537                     <span class="keywordtype">int</span> i = (l+r) &gt;&gt; 1;
00538                     <span class="keywordflow">if</span> (from &gt; e[i].time()) { 
00539                         l = i+1;
00540                     } <span class="keywordflow">else</span> { 
00541                         r = i;
00542                     }
00543                 }
00544                 assert(l == r &amp;&amp; (l == n || e[l].time() &gt;= from)); 
00545                 <span class="keywordflow">if</span> (l &lt; n) { 
00546                     <span class="keywordflow">if</span> (e[l].time() &lt;= till) {
00547                         first = pos = l;
00548                     }
00549                     <span class="keywordflow">return</span>;
00550                 }
00551             } <span class="keywordflow">while</span> (blocks.<a class="code" href="classdbCursor.html#dbCursora3">next</a>());
00552         }        
00553     }
00554             
<a name="l00559"></a><a class="code" href="classdbTimeSeriesIterator.html#dbTimeSeriesIteratora1">00559</a>     <span class="keywordtype">bool</span> <a class="code" href="classdbTimeSeriesIterator.html#dbTimeSeriesIteratora1">current</a>(T&amp; elem) { 
00560         <span class="keywordflow">if</span> (pos &gt;= 0) { 
00561             elem = blocks-&gt;elements[pos];
00562             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00563         }
00564         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00565     }
00566     
<a name="l00571"></a><a class="code" href="classdbTimeSeriesIterator.html#dbTimeSeriesIteratora2">00571</a>     <span class="keywordtype">bool</span> <a class="code" href="classdbTimeSeriesIterator.html#dbTimeSeriesIteratora2">next</a>() { 
00572         <span class="keywordflow">if</span> (pos &gt;= 0) { 
00573             <span class="keywordflow">if</span> (++pos == blocks-&gt;used) { 
00574                 <span class="keywordflow">if</span> (!blocks.<a class="code" href="classdbCursor.html#dbCursora3">next</a>()) { 
00575                     pos = -1;
00576                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00577                 }
00578                 pos = 0;
00579             }
00580             <span class="keywordflow">if</span> (blocks-&gt;elements[pos].time() &lt;= till) {
00581                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00582             }
00583             pos = -1;
00584         }
00585         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00586     }
00587 
<a name="l00591"></a><a class="code" href="classdbTimeSeriesIterator.html#dbTimeSeriesIteratora3">00591</a>     <span class="keywordtype">void</span> <a class="code" href="classdbTimeSeriesIterator.html#dbTimeSeriesIteratora3">reset</a>() { 
00592         blocks.<a class="code" href="classdbCursor.html#dbCursora5">first</a>();
00593         pos = first;
00594     }
00595     
<a name="l00600"></a><a class="code" href="classdbTimeSeriesIterator.html#dbTimeSeriesIteratora4">00600</a>     <a class="code" href="classdbTimeSeriesIterator.html#dbTimeSeriesIteratora4">dbTimeSeriesIterator</a>() {
00601         first = pos = -1;
00602     }
00603   <span class="keyword">private</span>:
00604     <a class="code" href="classdbCursor.html">dbCursor&lt; dbTimeSeriesBlock&lt;T&gt;</a> &gt; blocks;
00605     <span class="keywordtype">int</span>                              pos;
00606     <span class="keywordtype">int</span>                              first;
00607     time_t                           till;
00608 };
00609     
00613 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00614"></a><a class="code" href="classdbTimeSeriesReverseIterator.html">00614</a> <span class="keyword">class </span><a class="code" href="classdbTimeSeriesReverseIterator.html">dbTimeSeriesReverseIterator</a> { 
00615   <span class="keyword">public</span>:
<a name="l00623"></a><a class="code" href="classdbTimeSeriesReverseIterator.html#dbTimeSeriesReverseIteratora0">00623</a>     <span class="keywordtype">void</span> <a class="code" href="classdbTimeSeriesReverseIterator.html#dbTimeSeriesReverseIteratora0">start</a>(<a class="code" href="classdbTimeSeriesProcessor.html">dbTimeSeriesProcessor&lt;T&gt;</a>* processor, oid_t oid, time_t from, time_t till) { 
00624         last = pos = -1;
00625         this-&gt;from = from;
00626         <span class="keywordflow">if</span> (processor-&gt;<a class="code" href="classdbTimeSeriesProcessor.html#dbTimeSeriesProcessora14">_openIteratorCursor</a>(blocks, oid, from, till)) { 
00627             <span class="keywordflow">do</span> { 
00628                 <span class="keywordtype">int</span> n = blocks-&gt;used;
00629                 blocks.<a class="code" href="classdbCursor.html#dbCursora6">last</a>();
00630                 T <span class="keyword">const</span>* e =  blocks-&gt;elements.<a class="code" href="classdbCursor.html#dbCursora2">get</a>();
00631                 <span class="keywordtype">int</span> l = 0, r = n;
00632                 <span class="keywordflow">while</span> (l &lt; r)  {
00633                     <span class="keywordtype">int</span> i = (l+r) &gt;&gt; 1;
00634                     <span class="keywordflow">if</span> (till &gt;= e[i].time()) { 
00635                         l = i+1;
00636                     } <span class="keywordflow">else</span> { 
00637                         r = i;
00638                     }
00639                 }
00640                 assert(l == r &amp;&amp; (l == n || e[l].time() &gt; till)); 
00641                 <span class="keywordflow">if</span> (l &gt; 0) {
00642                     <span class="keywordflow">if</span> (e[l-1].time() &gt;= from) {
00643                         last = pos = l-1;
00644                     }
00645                     <span class="keywordflow">return</span>;
00646                 }
00647             } <span class="keywordflow">while</span> (blocks.<a class="code" href="classdbCursor.html#dbCursora4">prev</a>());
00648         }        
00649     }
00650             
<a name="l00655"></a><a class="code" href="classdbTimeSeriesReverseIterator.html#dbTimeSeriesReverseIteratora1">00655</a>     <span class="keywordtype">bool</span> <a class="code" href="classdbTimeSeriesReverseIterator.html#dbTimeSeriesReverseIteratora1">current</a>(T&amp; elem) { 
00656         <span class="keywordflow">if</span> (pos &gt;= 0) { 
00657             elem = blocks-&gt;elements[pos];
00658             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00659         }
00660         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00661     }
00662     
<a name="l00667"></a><a class="code" href="classdbTimeSeriesReverseIterator.html#dbTimeSeriesReverseIteratora2">00667</a>     <span class="keywordtype">bool</span> <a class="code" href="classdbTimeSeriesReverseIterator.html#dbTimeSeriesReverseIteratora2">next</a>() { 
00668         <span class="keywordflow">if</span> (pos &gt;= 0) { 
00669             <span class="keywordflow">if</span> (--pos &lt; 0) {
00670                 <span class="keywordflow">if</span> (!blocks.<a class="code" href="classdbCursor.html#dbCursora4">prev</a>()) { 
00671                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00672                 }
00673                 pos = blocks-&gt;used-1;
00674             }
00675             <span class="keywordflow">if</span> (blocks-&gt;elements[pos].time() &gt;= from) {
00676                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00677             }
00678             pos = -1;
00679         }
00680         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00681     }
00682 
<a name="l00686"></a><a class="code" href="classdbTimeSeriesReverseIterator.html#dbTimeSeriesReverseIteratora3">00686</a>     <span class="keywordtype">void</span> <a class="code" href="classdbTimeSeriesReverseIterator.html#dbTimeSeriesReverseIteratora3">reset</a>() { 
00687         blocks.<a class="code" href="classdbCursor.html#dbCursora6">last</a>();
00688         pos = last;
00689     }
00690     
<a name="l00695"></a><a class="code" href="classdbTimeSeriesReverseIterator.html#dbTimeSeriesReverseIteratora4">00695</a>     <a class="code" href="classdbTimeSeriesReverseIterator.html#dbTimeSeriesReverseIteratora4">dbTimeSeriesReverseIterator</a>() {
00696         last = pos = -1;
00697     }
00698   <span class="keyword">private</span>:
00699     <a class="code" href="classdbCursor.html">dbCursor&lt; dbTimeSeriesBlock&lt;T&gt;</a> &gt; blocks;
00700     <span class="keywordtype">int</span>                              pos;
00701     <span class="keywordtype">int</span>                              last;
00702     time_t                           from;
00703 };
00704     
00705 END_FASTDB_NAMESPACE
00706 
00707 <span class="preprocessor">#endif</span>
</pre></div><hr><address style="align: right;"><small>Generated on Thu Feb 14 12:42:30 2008 for FastDB by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
