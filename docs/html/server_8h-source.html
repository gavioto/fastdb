<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>server.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>server.h</h1><div class="fragment"><pre>00001 <span class="comment">//-&lt; SERVER.CPP &gt;----------------------------------------------------*--------*</span>
00002 <span class="comment">// FastDB                    Version 1.0         (c) 1999  GARRET    *     ?  *</span>
00003 <span class="comment">// (Main Memory Database Management System)                          *   /\|  *</span>
00004 <span class="comment">//                                                                   *  /  \  *</span>
00005 <span class="comment">//                          Created:     13-Jan-2000  K.A. Knizhnik  * / [] \ *</span>
00006 <span class="comment">//                          Last update: 13-Jan-2000  K.A. Knizhnik  * GARRET *</span>
00007 <span class="comment">//-------------------------------------------------------------------*--------*</span>
00008 <span class="comment">// CLI multithreaded server class</span>
00009 <span class="comment">//-------------------------------------------------------------------*--------*</span>
00010 
00011 <span class="preprocessor">#ifndef __SERVER_H__</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#define __SERVER_H__</span>
00013 <span class="preprocessor"></span>
00014 <span class="preprocessor">#include "sockio.h"</span>
00015 
00016 BEGIN_FASTDB_NAMESPACE
00017 
00018 <span class="keyword">class </span>dbColumnBinding { 
00019   <span class="keyword">public</span>:
00020     dbColumnBinding*   next;
00021     <a class="code" href="classdbFieldDescriptor.html">dbFieldDescriptor</a>* fd;
00022     <span class="keywordtype">int</span>                cliType;
00023     <span class="keywordtype">int</span>                len;
00024     <span class="keywordtype">char</span>*              ptr;
00025 
00026     <span class="keywordtype">int</span>  unpackArray(<span class="keywordtype">char</span>* dst, size_t offs);
00027     <span class="keywordtype">void</span> unpackScalar(<span class="keywordtype">char</span>* dst, <span class="keywordtype">bool</span> insert);
00028 
00029     dbColumnBinding(<a class="code" href="classdbFieldDescriptor.html">dbFieldDescriptor</a>* field, <span class="keywordtype">int</span> type) { 
00030         fd = field;
00031         cliType = type;
00032         next = NULL;
00033     }
00034 };
00035 
00036 <span class="keyword">struct </span>dbParameterBinding { 
00037     <span class="keyword">union </span>{ 
00038         int1       i1;
00039         int2       i2;
00040         int4       i4;
00041         db_int8    i8;
00042         real4      r4;
00043         real8      r8;
00044         oid_t      oid;
00045         <span class="keywordtype">bool</span>       b;
00046         <span class="keywordtype">char</span>*      str;
00047         <a class="code" href="classrectangle.html">rectangle</a>  rect;
00048     } u;
00049     <span class="keywordtype">int</span> type;
00050 };
00051 
00052 <span class="keyword">const</span> <span class="keywordtype">int</span> dbQueryMaxIdLength = 256;
00053 
00054 <span class="keyword">class </span>dbQueryScanner { 
00055   <span class="keyword">public</span>:
00056     <span class="keywordtype">char</span>*    p;
00057     db_int8     ival;
00058     real8    fval;
00059     <span class="keywordtype">char</span>     buf[dbQueryMaxIdLength];
00060     <span class="keywordtype">char</span>*    ident;
00061 
00062     <span class="keywordtype">int</span>  get();
00063 
00064     <span class="keywordtype">void</span> reset(<span class="keywordtype">char</span>* stmt) { 
00065         p = stmt;
00066     }
00067 };
00068     
00069 <span class="keyword">class </span>dbStatement { 
00070   <span class="keyword">public</span>:
00071     <span class="keywordtype">int</span>                 id;
00072     <span class="keywordtype">bool</span>                firstFetch;
00073     dbStatement*        next;
00074     <a class="code" href="classdbAnyCursor.html">dbAnyCursor</a>*        cursor; 
00075     <a class="code" href="classdbQuery.html">dbQuery</a>             query;
00076     dbColumnBinding*    columns;
00077     <span class="keywordtype">char</span>*               buf;
00078     <span class="keywordtype">int</span>                 buf_size;
00079     <span class="keywordtype">int</span>                 n_params;
00080     <span class="keywordtype">int</span>                 n_columns;
00081     dbParameterBinding* params;
00082     <a class="code" href="classdbTableDescriptor.html">dbTableDescriptor</a>*  table;
00083     
00084     <span class="keywordtype">void</span> reset();
00085 
00086     dbStatement(<span class="keywordtype">int</span> stmt_id) { 
00087         id = stmt_id;
00088         columns = NULL;
00089         params = NULL;
00090         buf = NULL;
00091         buf_size = 0;
00092         table = NULL;
00093         cursor = NULL;
00094     }
00095     ~dbStatement() { 
00096         reset(); 
00097         <span class="keyword">delete</span>[] buf;
00098     }
00099 };
00100 
00101 <span class="keyword">class </span>dbSession { 
00102   <span class="keyword">public</span>:
00103     dbSession*         next;  
00104     dbStatement*       stmts;
00105     dbQueryScanner     scanner;
00106     socket_t*          sock;
00107     <span class="keywordtype">bool</span>               in_transaction;
00108     <a class="code" href="classdbTableDescriptor.html">dbTableDescriptor</a>* dropped_tables;
00109     <a class="code" href="classdbTableDescriptor.html">dbTableDescriptor</a>* existed_tables;
00110 };
00111 
00112 <span class="keyword">class </span>dbServer {     
00113   <span class="keyword">protected</span>:
00114     <span class="keyword">static</span> dbServer* chain;
00115     dbServer*        next;
00116     <span class="keywordtype">char</span>*            URL;
00117     dbSession*       freeList;
00118     dbSession*       waitList;
00119     dbSession*       activeList;
00120     <span class="keywordtype">int</span>              optimalNumberOfThreads;
00121     <span class="keywordtype">int</span>              nActiveThreads;
00122     <span class="keywordtype">int</span>              nIdleThreads;
00123     <span class="keywordtype">int</span>              waitListLength;
00124     <span class="keywordtype">bool</span>             cancelWait;
00125     <span class="keywordtype">bool</span>             cancelAccept;
00126     <span class="keywordtype">bool</span>             cancelSession;
00127     dbMutex          mutex;
00128     dbLocalSemaphore go;
00129     dbLocalSemaphore done;
00130     socket_t*        globalAcceptSock;
00131     socket_t*        localAcceptSock;
00132     dbThread         localAcceptThread;
00133     dbThread         globalAcceptThread;
00134     <a class="code" href="classdbDatabase.html">dbDatabase</a>*      db;
00135 
00136     <span class="keyword">static</span> <span class="keywordtype">void</span> thread_proc serverThread(<span class="keywordtype">void</span>* arg);
00137     <span class="keyword">static</span> <span class="keywordtype">void</span> thread_proc acceptLocalThread(<span class="keywordtype">void</span>* arg);
00138     <span class="keyword">static</span> <span class="keywordtype">void</span> thread_proc acceptGlobalThread(<span class="keywordtype">void</span>* arg);
00139 
00140     <span class="keywordtype">void</span> serveClient();
00141     <span class="keywordtype">void</span> acceptConnection(socket_t* sock);
00142     
00143     
00144     <span class="keywordtype">bool</span> freeze(dbSession* session, <span class="keywordtype">int</span> stmt_id);
00145     <span class="keywordtype">bool</span> unfreeze(dbSession* session, <span class="keywordtype">int</span> stmt_id);
00146     <span class="keywordtype">bool</span> get_first(dbSession* session, <span class="keywordtype">int</span> stmt_id);
00147     <span class="keywordtype">bool</span> get_last(dbSession* session, <span class="keywordtype">int</span> stmt_id);
00148     <span class="keywordtype">bool</span> get_next(dbSession* session, <span class="keywordtype">int</span> stmt_id);
00149     <span class="keywordtype">bool</span> get_prev(dbSession* session, <span class="keywordtype">int</span> stmt_id);
00150     <span class="keywordtype">bool</span> seek(dbSession* session, <span class="keywordtype">int</span> stmt_id, <span class="keywordtype">char</span>* buf);
00151     <span class="keywordtype">bool</span> skip(dbSession* session, <span class="keywordtype">int</span> stmt_id, <span class="keywordtype">char</span>* buf);
00152     <span class="keywordtype">bool</span> fetch(dbSession* session, dbStatement* stmt, oid_t result);
00153     <span class="keywordtype">bool</span> fetch(dbSession* session, dbStatement* stmt) { 
00154         <span class="keywordflow">return</span> fetch(session, stmt, stmt-&gt;cursor-&gt;currId);
00155     }
00156     <span class="keywordtype">bool</span> remove(dbSession* session, <span class="keywordtype">int</span> stmt_id);
00157     <span class="keywordtype">bool</span> remove_current(dbSession* session, <span class="keywordtype">int</span> stmt_id);
00158     <span class="keywordtype">bool</span> update(dbSession* session, <span class="keywordtype">int</span> stmt_id, <span class="keywordtype">char</span>* new_data);
00159     <span class="keywordtype">bool</span> insert(dbSession* session, <span class="keywordtype">int</span> stmt_id, <span class="keywordtype">char</span>* data, <span class="keywordtype">bool</span> prepare);
00160     <span class="keywordtype">bool</span> select(dbSession* session, <span class="keywordtype">int</span> stmt_id, <span class="keywordtype">char</span>* data, <span class="keywordtype">bool</span> prepare);
00161     <span class="keywordtype">bool</span> show_tables(dbSession* session); 
00162     <span class="keywordtype">bool</span> describe_table(dbSession* session, <span class="keywordtype">char</span> <span class="keyword">const</span>* table);
00163     <span class="keywordtype">bool</span> create_table(dbSession* session, <span class="keywordtype">char</span>* data, <span class="keywordtype">bool</span> create);
00164     <span class="keywordtype">bool</span> drop_table(dbSession* session, <span class="keywordtype">char</span>* data);
00165     <span class="keywordtype">bool</span> alter_index(dbSession* session, <span class="keywordtype">char</span>* data);
00166 
00167     <span class="keywordtype">char</span>* checkColumns(dbStatement* stmt, <span class="keywordtype">int</span> n_columns, 
00168                        <a class="code" href="classdbTableDescriptor.html">dbTableDescriptor</a>* desc, <span class="keywordtype">char</span>* data, 
00169                        int4&amp; reponse);
00170       
00171     dbStatement* findStatement(dbSession* stmt, <span class="keywordtype">int</span> stmt_id);
00172 
00173   <span class="keyword">public</span>:
00174     <span class="keyword">static</span> dbServer* find(<span class="keywordtype">char</span> <span class="keyword">const</span>* serverURL);
00175     <span class="keyword">static</span> <span class="keywordtype">void</span>      cleanup();
00176 
00177     <span class="keywordtype">void</span> stop();
00178     <span class="keywordtype">void</span> start();
00179 
00180     dbServer(<a class="code" href="classdbDatabase.html">dbDatabase</a>* db,
00181              <span class="keywordtype">char</span> <span class="keyword">const</span>* serverURL, 
00182              <span class="keywordtype">int</span> optimalNumberOfThreads = 8,  
00183              <span class="keywordtype">int</span> connectionQueueLen = 64);
00184     ~dbServer();
00185 };
00186 
00187 END_FASTDB_NAMESPACE
00188 
00189 <span class="preprocessor">#endif</span>
</pre></div><hr><address style="align: right;"><small>Generated on Thu Feb 14 12:42:30 2008 for FastDB by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
