<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>array.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>array.h</h1><div class="fragment"><pre>00001 <span class="comment">//-&lt; ARRAY.H &gt;-------------------------------------------------------*--------*</span>
00002 <span class="comment">// FastDB                    Version 1.0         (c) 1999  GARRET    *     ?  *</span>
00003 <span class="comment">// (Main Memory Database Management System)                          *   /\|  *</span>
00004 <span class="comment">//                                                                   *  /  \  *</span>
00005 <span class="comment">//                          Created:     20-Nov-98    K.A. Knizhnik  * / [] \ *</span>
00006 <span class="comment">//                          Last update: 20-Dec-98    K.A. Knizhnik  * GARRET *</span>
00007 <span class="comment">//-------------------------------------------------------------------*--------*</span>
00008 <span class="comment">// Array type for table record fields</span>
00009 <span class="comment">//-------------------------------------------------------------------*--------*</span>
00010 
00011 <span class="preprocessor">#ifndef __ARRAY_H__</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#define __ARRAY_H__</span>
00013 <span class="preprocessor"></span>
00014 BEGIN_FASTDB_NAMESPACE
00015 
00016 <span class="preprocessor">#ifdef index // at some platform index(s,c) is defined strchr(s,x)</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#undef index</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00019 <span class="preprocessor"></span>
00020 <span class="preprocessor">#ifdef rindex // at some platform rindex(s,c) is defined strrchr(s,x)</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#undef rindex</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00023 <span class="preprocessor"></span>
<a name="l00027"></a><a class="code" href="classdbAnyArray.html">00027</a> <span class="keyword">class </span>FASTDB_DLL_ENTRY <a class="code" href="classdbAnyArray.html">dbAnyArray</a> { 
00028     <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classdbTableDescriptor.html">dbTableDescriptor</a>;
00029   <span class="keyword">protected</span>:
00030     size_t len;
00031 
00032   <span class="keyword">public</span>:
00033     <span class="keyword">static</span> <span class="keywordtype">void</span> arrayAllocator(<a class="code" href="classdbAnyArray.html">dbAnyArray</a>* aArray, <span class="keywordtype">void</span>* data, size_t length)
00034     {
00035         aArray-&gt;<a class="code" href="classdbAnyArray.html#dbArrayn2">len</a> = length;
00036         *(<span class="keywordtype">void</span>**)(aArray+1) = data;
00037     }
<a name="l00042"></a><a class="code" href="classdbAnyArray.html#dbArraya20">00042</a>     size_t length()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> len; }
00043 
<a name="l00048"></a><a class="code" href="classdbAnyArray.html#dbArraya21">00048</a>     <span class="keywordtype">void</span> <span class="keyword">const</span>* base()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> *(<span class="keywordtype">void</span>*<span class="keyword">const</span>*)(<span class="keyword">this</span>+1); }
00049 };    
00050 
00051 
00055 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<a name="l00056"></a><a class="code" href="classdbArray.html">00056</a> <span class="keyword">class </span><a class="code" href="classdbArray.html">dbArray</a> : <span class="keyword">public</span> <a class="code" href="classdbAnyArray.html">dbAnyArray</a> { 
00057     <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classdbTableDescriptor.html">dbTableDescriptor</a>;
00058   <span class="keyword">protected</span>:
00059     T*     data;
00060     size_t allocated;
00061     
00062     <span class="keyword">static</span> <span class="keywordtype">void</span> arrayAllocator(<a class="code" href="classdbAnyArray.html">dbAnyArray</a>* aArray, <span class="keywordtype">void</span>* data, size_t <a class="code" href="classdbAnyArray.html#dbArraya20">length</a>)
00063     {
00064         <a class="code" href="classdbArray.html">dbArray</a>* array = (<a class="code" href="classdbArray.html">dbArray</a>*)aArray;
00065         array-&gt;<a class="code" href="classdbAnyArray.html#dbArrayn2">len</a> = <a class="code" href="classdbAnyArray.html#dbArraya20">length</a>;
00066         <span class="keywordflow">if</span> (array-&gt;<a class="code" href="classdbArray.html#dbArrayn1">allocated</a>) { 
00067             <span class="keyword">delete</span>[] array-&gt;<a class="code" href="classdbArray.html#dbArrayn0">data</a>;
00068         }
00069         <span class="keywordflow">if</span> (data != NULL || <a class="code" href="classdbAnyArray.html#dbArraya20">length</a> == 0) { 
00070             array-&gt;<a class="code" href="classdbArray.html#dbArrayn0">data</a> = (T*)data;
00071             array-&gt;<a class="code" href="classdbArray.html#dbArrayn1">allocated</a> = 0;
00072         } <span class="keywordflow">else</span> { 
00073             array-&gt;<a class="code" href="classdbArray.html#dbArrayn0">data</a> = <span class="keyword">new</span> T[<a class="code" href="classdbAnyArray.html#dbArraya20">length</a>];
00074             array-&gt;<a class="code" href="classdbArray.html#dbArrayn1">allocated</a> = <a class="code" href="classdbAnyArray.html#dbArraya20">length</a>;
00075         }
00076     }
00077  
00078     <span class="keyword">inline</span> <span class="keywordtype">void</span> memcpy(T* dst, T <span class="keyword">const</span>* src, size_t len) { 
00079         <span class="keywordtype">int</span> n = (int)len;
00080         <span class="keywordflow">while</span> (--n &gt;= 0) { 
00081             *dst++ = *src++;
00082         }
00083     }
00084 
00085     <span class="keyword">inline</span> <span class="keywordtype">void</span> memmove(T* dst, T <span class="keyword">const</span>* src, size_t len) { 
00086         <span class="keywordtype">int</span> n = (int)len;
00087         <span class="keywordflow">if</span> (dst &lt; src) {
00088             <span class="keywordflow">while</span> (--n &gt;= 0) { 
00089                 *dst++ = *src++;
00090             }
00091         } <span class="keywordflow">else</span> { 
00092             dst += n;
00093             src += n;       
00094             <span class="keywordflow">while</span> (--n &gt;= 0) { 
00095                 *--dst = *--src;
00096             }
00097         }
00098     }
00099  
00100   <span class="keyword">public</span>:
00101     <a class="code" href="classdbFieldDescriptor.html">dbFieldDescriptor</a>* dbDescribeComponents(<a class="code" href="classdbFieldDescriptor.html">dbFieldDescriptor</a>* fd) { 
00102         fd-&gt;<a class="code" href="classdbFieldDescriptor.html#dbFieldDescriptorm14">type</a> = fd-&gt;<a class="code" href="classdbFieldDescriptor.html#dbFieldDescriptorm15">appType</a> = dbField::tpArray;
00103         fd-&gt;<a class="code" href="classdbFieldDescriptor.html#dbFieldDescriptorm22">dbsSize</a> = <span class="keyword">sizeof</span>(dbVarying);
00104         fd-&gt;<a class="code" href="classdbFieldDescriptor.html#dbFieldDescriptorm24">alignment</a> = 4;
00105         fd-&gt;<a class="code" href="classdbFieldDescriptor.html#dbFieldDescriptorm31">arrayAllocator</a> = arrayAllocator;
00106         <span class="keywordflow">return</span> dbDescribeField(<span class="keyword">new</span> <a class="code" href="classdbFieldDescriptor.html">dbFieldDescriptor</a>(<span class="stringliteral">"[]"</span>, 0, <span class="keyword">sizeof</span>(T), 0),
00107                                *(T*)fd); 
00108     }
00109 
<a name="l00113"></a><a class="code" href="classdbArray.html#dbArraya1">00113</a>     <a class="code" href="classdbArray.html#dbArraya1">dbArray</a>() { 
00114         data = NULL; 
00115         len = 0;
00116         allocated = 0;
00117     }
00118 
<a name="l00123"></a><a class="code" href="classdbArray.html#dbArraya2">00123</a>     <a class="code" href="classdbArray.html#dbArraya1">dbArray</a>(size_t size) { 
00124         data = (size != 0) <span class="keyword">new</span> T[size] : NULL;
00125         len = size;
00126         allocated = size;
00127     }
00128 
<a name="l00136"></a><a class="code" href="classdbArray.html#dbArraya3">00136</a>     <a class="code" href="classdbArray.html#dbArraya1">dbArray</a>(T <span class="keyword">const</span>* ptr, size_t size, size_t allocate = 0) { 
00137         len = size;
00138         allocated = allocate;
00139         <span class="keywordflow">if</span> (allocate != 0) { 
00140             assert(allocate &gt;= size);
00141             data = <span class="keyword">new</span> T[allocate];
00142             memcpy(data, ptr, size);    
00143         } <span class="keywordflow">else</span> { 
00144             data = (T*)ptr;
00145         }
00146     }
00147 
<a name="l00152"></a><a class="code" href="classdbArray.html#dbArraya4">00152</a>     <a class="code" href="classdbArray.html#dbArraya1">dbArray</a>(<a class="code" href="classdbArray.html">dbArray</a> <span class="keyword">const</span>&amp; arr) { 
00153         allocated = arr.<a class="code" href="classdbArray.html#dbArrayn1">allocated</a>;
00154         len = arr.<a class="code" href="classdbAnyArray.html#dbArrayn2">len</a>;
00155         <span class="keywordflow">if</span> (allocated) { 
00156             data = <span class="keyword">new</span> T[allocated];
00157             memcpy(data, arr.<a class="code" href="classdbArray.html#dbArrayn0">data</a>, len);        
00158         } <span class="keywordflow">else</span> { 
00159             data = arr.<a class="code" href="classdbArray.html#dbArrayn0">data</a>;
00160         }
00161     }
00162 
<a name="l00166"></a><a class="code" href="classdbArray.html#dbArraya5">00166</a>     <a class="code" href="classdbArray.html#dbArraya5">~dbArray</a>() { 
00167         <span class="keywordflow">if</span> (allocated) { 
00168             <span class="keyword">delete</span>[] data;
00169         }
00170     }
00171 
<a name="l00176"></a><a class="code" href="classdbArray.html#dbArraya6">00176</a>     <a class="code" href="classdbArray.html">dbArray</a>&amp; <a class="code" href="classdbArray.html#dbArraya6">operator = </a>(<a class="code" href="classdbArray.html">dbArray</a> <span class="keyword">const</span>&amp; arr) { 
00177         <span class="keywordflow">if</span> (<span class="keyword">this</span> == &amp;arr) { 
00178             <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00179         }
00180         <span class="keywordflow">if</span> (allocated) { 
00181             <span class="keyword">delete</span>[] data;
00182         }
00183         <span class="keywordflow">if</span> ((len = arr.<a class="code" href="classdbAnyArray.html#dbArrayn2">len</a>) != 0) { 
00184             data = <span class="keyword">new</span> T[len];
00185             memcpy(data, arr.<a class="code" href="classdbArray.html#dbArrayn0">data</a>, len);
00186         }
00187         allocated = len;
00188         <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00189     }
00190 
<a name="l00195"></a><a class="code" href="classdbArray.html#dbArraya7">00195</a>     T <span class="keyword">const</span>&amp; <a class="code" href="classdbArray.html#dbArraya7">last</a>() {
00196         assert(len &gt; 0);
00197         <span class="keywordflow">return</span> data[len-1];
00198     }
00199 
<a name="l00207"></a><a class="code" href="classdbArray.html#dbArraya8">00207</a>     <span class="keywordtype">void</span> <a class="code" href="classdbArray.html#dbArraya8">assign</a>(T <span class="keyword">const</span>* ptr, size_t size, <span class="keywordtype">bool</span> copy = <span class="keyword">true</span>) { 
00208         <span class="keywordflow">if</span> (allocated) { 
00209             <span class="keyword">delete</span>[] data;
00210         }
00211         len = size;
00212         <span class="keywordflow">if</span> (copy &amp;&amp; size != 0) { 
00213             data = <span class="keyword">new</span> T[size];
00214             memcpy(data, ptr, size);    
00215             allocated = size;
00216         } <span class="keywordflow">else</span> { 
00217             data = (T*)ptr;
00218             allocated = 0;
00219         }
00220     }
00221 
<a name="l00227"></a><a class="code" href="classdbArray.html#dbArraya9">00227</a>     T <span class="keyword">const</span>&amp; <a class="code" href="classdbArray.html#dbArraya9">operator []</a>(size_t index)<span class="keyword"> const </span>{ 
00228         assert(index &lt; len);
00229         <span class="keywordflow">return</span> data[index];
00230     }
00231 
<a name="l00237"></a><a class="code" href="classdbArray.html#dbArraya10">00237</a>     <span class="keywordtype">void</span> <a class="code" href="classdbArray.html#dbArraya10">putat</a>(size_t index, T <span class="keyword">const</span>&amp; value) { 
00238         assert(index &lt; len);
00239         <span class="keywordflow">if</span> (!allocated) { 
00240             T* copy = <span class="keyword">new</span> T[len];
00241             memcpy(copy, data, len);
00242             data = copy;
00243             allocated = len;
00244         }
00245         data[index] = value;
00246     }
00247 
00248     
<a name="l00254"></a><a class="code" href="classdbArray.html#dbArraya11">00254</a>     T <span class="keyword">const</span>&amp; <a class="code" href="classdbArray.html#dbArraya11">getat</a>(size_t index)<span class="keyword"> const </span>{
00255         assert(index &lt; len);
00256         <span class="keywordflow">return</span> data[index];
00257     }
00258 
<a name="l00262"></a><a class="code" href="classdbArray.html#dbArraya12">00262</a>     <span class="keywordtype">void</span> <a class="code" href="classdbArray.html#dbArraya12">clear</a>() { 
00263         <span class="keywordflow">if</span> (allocated) {
00264             <span class="keyword">delete</span>[] data;
00265         }
00266         data = NULL;
00267         len = 0;
00268         allocated = 0;
00269     }
00270 
<a name="l00275"></a><a class="code" href="classdbArray.html#dbArraya13">00275</a>     <span class="keywordtype">void</span> <a class="code" href="classdbArray.html#dbArraya13">resize</a>(size_t size) { 
00276         <span class="keywordflow">if</span> (size &gt; len &amp;&amp; size &gt; allocated) { 
00277             T* p = <span class="keyword">new</span> T[size];
00278             memcpy(p, data, len);
00279             <span class="keywordflow">if</span> (allocated) { 
00280                 <span class="keyword">delete</span>[] data;
00281             }
00282             data = p;
00283             allocated = size;
00284         }
00285         len = size;
00286     }
00287 
<a name="l00292"></a><a class="code" href="classdbArray.html#dbArraya14">00292</a>     <span class="keywordtype">void</span> <a class="code" href="classdbArray.html#dbArraya14">append</a>(T <span class="keyword">const</span>&amp; value) { 
00293         <a class="code" href="classdbArray.html#dbArraya16">insert</a>(value, len);
00294     }
00295     
<a name="l00303"></a><a class="code" href="classdbArray.html#dbArraya15">00303</a>     <span class="keywordtype">int</span> <a class="code" href="classdbArray.html#dbArraya15">bsearch</a>(T value) {
00304         size_t l = 0, r = len;
00305         <span class="keywordflow">while</span> (l &lt; r) { 
00306             size_t m = (l + 1) &gt;&gt; 1;
00307             <span class="keywordflow">if</span> (data[m] &lt; value) { 
00308                 l = m + 1;
00309             } <span class="keywordflow">else</span> { 
00310                 r = m;
00311             }
00312         }
00313         <span class="keywordflow">return</span> r;
00314     }
00315 
<a name="l00321"></a><a class="code" href="classdbArray.html#dbArraya16">00321</a>     <span class="keywordtype">void</span> <a class="code" href="classdbArray.html#dbArraya16">insert</a>(T <span class="keyword">const</span>&amp; value, size_t index = 0) { 
00322         assert(index &lt;= len);
00323         <span class="keywordflow">if</span> (len &gt;= allocated) {
00324             size_t newSize = len == 0 ? 8 : len*2;
00325             T* p = <span class="keyword">new</span> T[newSize];
00326             memcpy(p, data, index);
00327             p[index] = value;
00328             memcpy(p+index+1, data+index, (len-index));
00329             <span class="keywordflow">if</span> (allocated) { 
00330                 <span class="keyword">delete</span>[] data;
00331             }
00332             data = p;
00333             allocated = newSize;
00334         } <span class="keywordflow">else</span> { 
00335             memmove(data+index+1, data+index, (len-index));
00336             data[index] = value;
00337         }
00338         len += 1;
00339     }
00340     
<a name="l00345"></a><a class="code" href="classdbArray.html#dbArraya17">00345</a>     <span class="keywordtype">void</span> <a class="code" href="classdbArray.html#dbArraya17">remove</a>(size_t index) { 
00346         assert(index &lt; len);
00347         len -= 1;
00348         <span class="keywordflow">if</span> (index != len &amp;&amp; !allocated) { 
00349             T* p = <span class="keyword">new</span> T[len];
00350             memcpy(p, data, index);
00351             memcpy(p+index, data+index+1, (len-index));
00352             allocated = len;
00353             data = p;
00354         } <span class="keywordflow">else</span> { 
00355             memmove(data+index, data+index+1, (len-index));
00356         }
00357     }
00358 
<a name="l00363"></a><a class="code" href="classdbArray.html#dbArraya18">00363</a>     T <span class="keyword">const</span>* <a class="code" href="classdbArray.html#dbArraya18">get</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> data; }
00364 
<a name="l00369"></a><a class="code" href="classdbArray.html#dbArraya19">00369</a>     T* <a class="code" href="classdbArray.html#dbArraya19">update</a>() { 
00370         <span class="keywordflow">if</span> (!allocated) {
00371             T* copy = <span class="keyword">new</span> T[len];
00372             memcpy(copy, data, len);
00373             data = copy;
00374             allocated = len;
00375         }
00376         <span class="keywordflow">return</span> data; 
00377     }
00378 };
00379 
00385 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
00386 <span class="keywordtype">int</span> index(<a class="code" href="classdbArray.html">dbArray&lt;T&gt;</a> <span class="keyword">const</span>&amp; a, T value) {
00387     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0, n = a.<a class="code" href="classdbAnyArray.html#dbArraya20">length</a>(); i &lt; n; i++) {
00388       <span class="keywordflow">if</span> (a[i] == value) {
00389           <span class="keywordflow">return</span> i;
00390       }
00391     }
00392     <span class="keywordflow">return</span> -1;
00393 }
00394 
00400 <span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
00401 <span class="keywordtype">int</span> rindex(<a class="code" href="classdbArray.html">dbArray&lt;T&gt;</a> <span class="keyword">const</span>&amp; a, T value) {
00402     <span class="keywordtype">int</span> i = a.<a class="code" href="classdbAnyArray.html#dbArraya20">length</a>();
00403     <span class="keywordflow">while</span> (--i &gt;= 0 &amp;&amp; a[i] != value);
00404     <span class="keywordflow">return</span> i;
00405 }
00406 
00407 END_FASTDB_NAMESPACE
00408 
00409 <span class="preprocessor">#endif</span>
00410 <span class="preprocessor"></span>
</pre></div><hr><address style="align: right;"><small>Generated on Thu Feb 14 12:42:30 2008 for FastDB by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
