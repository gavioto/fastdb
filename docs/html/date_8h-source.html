<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>date.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>date.h</h1><div class="fragment"><pre>00001 <span class="comment">//-&lt; DATE.H &gt;--------------------------------------------------------*--------*</span>
00002 <span class="comment">// FastDB                    Version 1.0         (c) 1999  GARRET    *     ?  *</span>
00003 <span class="comment">// (Main Memory Database Management System)                          *   /\|  *</span>
00004 <span class="comment">//                                                                   *  /  \  *</span>
00005 <span class="comment">//                          Created:     30-Apr-2000  K.A. Knizhnik  * / [] \ *</span>
00006 <span class="comment">//                          Last update: 30-Apr-2000  K.A. Knizhnik  * GARRET *</span>
00007 <span class="comment">//-------------------------------------------------------------------*--------*</span>
00008 <span class="comment">// Date field type</span>
00009 <span class="comment">//-------------------------------------------------------------------*--------*</span>
00010 
00011 <span class="preprocessor">#ifndef __DATE_H__</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#define __DATE_H__</span>
00013 <span class="preprocessor"></span>
00014 <span class="preprocessor">#include "stdtp.h"</span>
00015 <span class="preprocessor">#include "class.h"</span>
00016 
00017 BEGIN_FASTDB_NAMESPACE
00018 
00019 <span class="preprocessor">#if !defined(NO_PTHREADS) &amp;&amp; !defined(_WIN32)</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#define USE_REENTRANT_LIBRARY</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00022 <span class="preprocessor"></span>
00023 <span class="keyword">class </span>FASTDB_DLL_ENTRY dbDate { 
00024     int4 jday;
00025   <span class="keyword">public</span>:
00026     <span class="keywordtype">bool</span> operator == (dbDate <span class="keyword">const</span>&amp; dt) { 
00027         <span class="keywordflow">return</span> jday == dt.jday;
00028     }
00029     <span class="keywordtype">bool</span> operator != (dbDate <span class="keyword">const</span>&amp; dt) { 
00030         <span class="keywordflow">return</span> jday != dt.jday;
00031     }
00032     <span class="keywordtype">bool</span> operator &gt; (dbDate <span class="keyword">const</span>&amp; dt) { 
00033         <span class="keywordflow">return</span> jday &gt; dt.jday;
00034     }
00035     <span class="keywordtype">bool</span> operator &gt;= (dbDate <span class="keyword">const</span>&amp; dt) { 
00036         <span class="keywordflow">return</span> jday &gt;= dt.jday;
00037     }
00038     <span class="keywordtype">bool</span> operator &lt; (dbDate <span class="keyword">const</span>&amp; dt) { 
00039         <span class="keywordflow">return</span> jday &lt; dt.jday;
00040     }
00041     <span class="keywordtype">bool</span> operator &lt;= (dbDate <span class="keyword">const</span>&amp; dt) { 
00042         <span class="keywordflow">return</span> jday &lt;= dt.jday;
00043     }
00044     <span class="keywordtype">int</span> operator - (dbDate <span class="keyword">const</span>&amp; dt) { 
00045         <span class="keywordflow">return</span> jday - dt.jday;
00046     }
00047     <span class="keywordtype">int</span> operator + (<span class="keywordtype">int</span> days) { 
00048         <span class="keywordflow">return</span> jday + days;
00049     }
00050     dbDate&amp; operator += (<span class="keywordtype">int</span> days) { 
00051         jday += days;
00052         <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00053     }
00054     dbDate&amp; operator -= (<span class="keywordtype">int</span> days) { 
00055         jday -= days;
00056         <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00057     }
00058     <span class="keyword">static</span> dbDate current() { 
00059         time_t now = time(NULL);
00060         <span class="keyword">struct </span>tm* tp;
00061 <span class="preprocessor">#ifdef USE_REENTRANT_LIBRARY</span>
00062 <span class="preprocessor"></span>        <span class="keyword">struct </span>tm t;
00063         tp = localtime_r(&amp;now, &amp;t);
00064 <span class="preprocessor">#else </span>
00065 <span class="preprocessor"></span>        tp = localtime(&amp;now);
00066 <span class="preprocessor">#endif</span>
00067 <span class="preprocessor"></span>        <span class="keywordflow">return</span> dbDate(tp-&gt;tm_year + 1900, tp-&gt;tm_mon + 1, tp-&gt;tm_mday);
00068     }
00069 
00070     dbDate() { 
00071         jday = -1;
00072     } 
00073     <span class="keywordtype">bool</span> isValid()<span class="keyword">const</span>  { 
00074         <span class="keywordflow">return</span> jday != -1;
00075     }
00076 
00077     <span class="keywordtype">unsigned</span> JulianDay() { <span class="keywordflow">return</span> jday; }
00078 
00079     <span class="keywordtype">void</span> clear() { jday = -1; }
00080 
00081     dbDate(<span class="keywordtype">int</span> year, <span class="keywordtype">int</span> month, <span class="keywordtype">int</span> day)  {
00082     <span class="comment">/*</span>
00083 <span class="comment">      Convert Gregorian calendar date to the corresponding Julian day number</span>
00084 <span class="comment">      j.  Algorithm 199 from Communications of the ACM, Volume 6, No. 8,</span>
00085 <span class="comment">      (Aug. 1963), p. 444.  Gregorian calendar started on Sep. 14, 1752.</span>
00086 <span class="comment">      This function not valid before that.</span>
00087 <span class="comment">      */</span>
00088         nat4 c, ya;
00089         <span class="keywordflow">if</span> (month &gt; 2)
00090             month -= 3;
00091         <span class="keywordflow">else</span> {
00092             month += 9;
00093             year--;
00094         } <span class="comment">/* else */</span>
00095         c = year / 100;
00096         ya = year - 100*c;
00097         jday = ((146097*c)&gt;&gt;2) + ((1461*ya)&gt;&gt;2) + (153*month + 2)/5 + day + 1721119;
00098     } <span class="comment">/* jday */</span>
00099 
00100     <span class="keywordtype">void</span> MDY(<span class="keywordtype">int</span>&amp; year, <span class="keywordtype">int</span>&amp; month, <span class="keywordtype">int</span>&amp; day)<span class="keyword"> const </span>{ 
00101     <span class="comment">/*</span>
00102 <span class="comment">      Convert a Julian day number to its corresponding Gregorian calendar</span>
00103 <span class="comment">      date.  Algorithm 199 from Communications of the ACM, Volume 6, No. 8,</span>
00104 <span class="comment">      (Aug. 1963), p. 444.  Gregorian calendar started on Sep. 14, 1752.</span>
00105 <span class="comment">      This function not valid before that.</span>
00106 <span class="comment">     */</span>
00107         nat4 j = jday - 1721119;
00108         <span class="keywordtype">int</span> m, d, y;
00109         y = (((j&lt;&lt;2) - 1) / 146097);
00110         j = (j&lt;&lt;2) - 1 - 146097*y;
00111         d = (j&gt;&gt;2);
00112         j = ((d&lt;&lt;2) + 3) / 1461;
00113         d = ((d&lt;&lt;2) + 3 - 1461*j);
00114         d = (d + 4)&gt;&gt;2;
00115         m = (5*d - 3)/153;
00116         d = 5*d - 3 - 153*m;
00117         d = (d + 5)/5;
00118         y = (100*y + j);
00119         <span class="keywordflow">if</span> (m &lt; 10) { 
00120                 m += 3;
00121         } <span class="keywordflow">else</span> {
00122                 m -= 9;
00123                 y++;
00124         } <span class="comment">/* else */</span>
00125         month = m;
00126         day = d;
00127         year = y;
00128     } <span class="comment">/* mdy */</span>
00129 
00130     <span class="keywordtype">int</span> day() {
00131         <span class="keywordtype">int</span> month, day, year;
00132         MDY(year, month, day);
00133         <span class="keywordflow">return</span> day;
00134     }
00135 
00136     <span class="keywordtype">int</span> month() {
00137         <span class="keywordtype">int</span> month, day, year;
00138         MDY(year, month, day);
00139         <span class="keywordflow">return</span> month;
00140     }
00141 
00142     <span class="keywordtype">int</span> year() {
00143         <span class="keywordtype">int</span> month, day, year;
00144         MDY(year, month, day);
00145         <span class="keywordflow">return</span> year;
00146     }
00147 
00148     <span class="keywordtype">int</span> dayOfWeek() { 
00149         <span class="keywordflow">return</span> (jday % 7) + 1;
00150     }
00151 
00152     <span class="keywordtype">char</span>* asString(<span class="keywordtype">char</span>* buf, <span class="keywordtype">char</span> <span class="keyword">const</span>* format = <span class="stringliteral">"%d-%M-%Y"</span>)<span class="keyword"> const </span>{ 
00153         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* dayName[] = { <span class="stringliteral">"Mon"</span>, <span class="stringliteral">"Tue"</span>, <span class="stringliteral">"Wen"</span>, <span class="stringliteral">"Thu"</span>, <span class="stringliteral">"Fri"</span>, <span class="stringliteral">"Sat"</span>, <span class="stringliteral">"Sun"</span> };
00154         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* monthName[] = { <span class="stringliteral">"Jan"</span>, <span class="stringliteral">"Feb"</span>, <span class="stringliteral">"Mar"</span>, <span class="stringliteral">"Apr"</span>, <span class="stringliteral">"May"</span>, <span class="stringliteral">"Jun"</span>, <span class="stringliteral">"Jul"</span>,
00155                                            <span class="stringliteral">"Aug"</span>, <span class="stringliteral">"Sep"</span>, <span class="stringliteral">"Oct"</span>, <span class="stringliteral">"Nov"</span>, <span class="stringliteral">"Dec"</span> };
00156         <span class="keywordtype">int</span> month, day, year;
00157         MDY(year, month, day);
00158         <span class="keywordtype">char</span> ch, *dst = buf;
00159         <span class="keywordflow">while</span> ((ch = *format++) != <span class="charliteral">'\0'</span>) { 
00160             <span class="keywordflow">if</span> (ch == <span class="charliteral">'%'</span>) {
00161                 ch = *format++;
00162                 <span class="keywordflow">switch</span> (ch) { 
00163                   <span class="keywordflow">case</span> <span class="charliteral">'d'</span>: dst += sprintf(dst, <span class="stringliteral">"%02u"</span>, day ); <span class="keywordflow">continue</span>;
00164                   <span class="keywordflow">case</span> <span class="charliteral">'D'</span>: dst += sprintf(dst, <span class="stringliteral">"%s"</span>,   dayName[jday % 7]); <span class="keywordflow">continue</span>;
00165                   <span class="keywordflow">case</span> <span class="charliteral">'m'</span>: dst += sprintf(dst, <span class="stringliteral">"%02u"</span>, month); <span class="keywordflow">continue</span>;
00166                   <span class="keywordflow">case</span> <span class="charliteral">'M'</span>: dst += sprintf(dst, <span class="stringliteral">"%s"</span>,   monthName[month - 1]); <span class="keywordflow">continue</span>;
00167                   <span class="keywordflow">case</span> <span class="charliteral">'y'</span>: dst += sprintf(dst, <span class="stringliteral">"%02u"</span>, year - 1900); <span class="keywordflow">continue</span>;
00168                   <span class="keywordflow">case</span> <span class="charliteral">'Y'</span>: dst += sprintf(dst, <span class="stringliteral">"%04u"</span>, year); <span class="keywordflow">continue</span>;
00169                   <span class="keywordflow">default</span>: *dst++ = ch;
00170                 }
00171             } <span class="keywordflow">else</span> { 
00172                 *dst++ = ch;
00173             }
00174         }
00175         *dst = <span class="charliteral">'\0'</span>;
00176         <span class="keywordflow">return</span> buf;
00177     }
00178 
00179 
00180     CLASS_DESCRIPTOR(dbDate, 
00181                      (KEY(jday,INDEXED|HASHED), 
00182                       METHOD(year), METHOD(month), METHOD(day), METHOD(dayOfWeek)));
00183 
00184     <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> operator == (<span class="keywordtype">char</span> <span class="keyword">const</span>* field) { 
00185         <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> expr;
00186         expr = <a class="code" href="classdbComponent.html">dbComponent</a>(field,<span class="stringliteral">"jday"</span>),<span class="stringliteral">"="</span>,jday;
00187         <span class="keywordflow">return</span> expr;
00188     }
00189     <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> operator != (<span class="keywordtype">char</span> <span class="keyword">const</span>* field) { 
00190         <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> expr;
00191         expr = <a class="code" href="classdbComponent.html">dbComponent</a>(field,<span class="stringliteral">"jday"</span>),<span class="stringliteral">"&lt;&gt;"</span>,jday;
00192         <span class="keywordflow">return</span> expr;
00193     }
00194     <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> operator &lt; (<span class="keywordtype">char</span> <span class="keyword">const</span>* field) { 
00195         <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> expr;
00196         expr = <a class="code" href="classdbComponent.html">dbComponent</a>(field,<span class="stringliteral">"jday"</span>),<span class="stringliteral">"&gt;"</span>,jday;
00197         <span class="keywordflow">return</span> expr;
00198     }
00199     <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> operator &lt;= (<span class="keywordtype">char</span> <span class="keyword">const</span>* field) { 
00200         <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> expr;
00201         expr = <a class="code" href="classdbComponent.html">dbComponent</a>(field,<span class="stringliteral">"jday"</span>),<span class="stringliteral">"&gt;="</span>,jday;
00202         <span class="keywordflow">return</span> expr;
00203     }
00204     <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> operator &gt; (<span class="keywordtype">char</span> <span class="keyword">const</span>* field) { 
00205         <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> expr;
00206         expr = <a class="code" href="classdbComponent.html">dbComponent</a>(field,<span class="stringliteral">"jday"</span>),<span class="stringliteral">"&lt;"</span>,jday;
00207         <span class="keywordflow">return</span> expr;
00208     }
00209     <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> operator &gt;= (<span class="keywordtype">char</span> <span class="keyword">const</span>* field) { 
00210         <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> expr;
00211         expr = <a class="code" href="classdbComponent.html">dbComponent</a>(field,<span class="stringliteral">"jday"</span>),<span class="stringliteral">"&lt;="</span>,jday;
00212         <span class="keywordflow">return</span> expr;
00213     }
00214     <span class="keyword">friend</span> <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> between(<span class="keywordtype">char</span> <span class="keyword">const</span>* field, dbDate&amp; from,
00215                                      dbDate&amp; till)
00216     { 
00217         <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> expr;
00218         expr=<a class="code" href="classdbComponent.html">dbComponent</a>(field,<span class="stringliteral">"jday"</span>),<span class="stringliteral">"between"</span>,from.jday,<span class="stringliteral">"and"</span>,till.jday;
00219         <span class="keywordflow">return</span> expr;
00220     }
00221 
00222     <span class="keyword">static</span> <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> ascent(<span class="keywordtype">char</span> <span class="keyword">const</span>* field) { 
00223         <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> expr;
00224         expr=<a class="code" href="classdbComponent.html">dbComponent</a>(field,<span class="stringliteral">"jday"</span>);
00225         <span class="keywordflow">return</span> expr;
00226     }   
00227     <span class="keyword">static</span> <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> descent(<span class="keywordtype">char</span> <span class="keyword">const</span>* field) { 
00228         <a class="code" href="classdbQueryExpression.html">dbQueryExpression</a> expr;
00229         expr=<a class="code" href="classdbComponent.html">dbComponent</a>(field,<span class="stringliteral">"jday"</span>),<span class="stringliteral">"desc"</span>;
00230         <span class="keywordflow">return</span> expr;
00231     }   
00232 };
00233 
00234 END_FASTDB_NAMESPACE
00235 
00236 <span class="preprocessor">#endif</span>
</pre></div><hr><address style="align: right;"><small>Generated on Thu Feb 14 12:42:30 2008 for FastDB by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
